---
title: "case study 4 with different data"
output: html_notebook
---


Lance Dacy, Reanan McDaniel, Shawn Jung, Jonathan Tan

```{r}
#analysis packages
library(tswge)
library(changepoint)
library(tseries)
library(DataExplorer)

#data manipulation
library(dplyr)
library(lubridate)
library(tibbletime)

#visualization
library(ggplot2)
library(cowplot)
library(kableExtra)

#data source
library(cdcfluview)
```

import data from... ??? https://apps.who.int/flumart/Default?ReportNo=12
query below is SE Asia from 1995 to 2019
```{r}
raw_data  <- read.csv('D:/SMU/DS 7333 Quantify The World/FluNetInteractiveReport(SE_Asia_1995-2019).csv')
```
Column guide for WHO data csv columns
SPEC_RECIEVED_NB - Specimens recieved by the WHO
SPEC_PROCESSED_NB - specimens processed by the WHO
AH1 - all A type influenza viruses categorized by subtype
A(H1N1pdm09
AH3
AH5
ANOTSUBTYPED
INF(A) - total of all influenza A viruses detected
BYAMAGATA - B(Yamagata lineage) - various types of influenze B type viruses
BVICTORIA - B(Victoria Lineage)
BNOTDETERMINED
INF_B - total influenze B viruses 
ALL_INF - number of influenze positive viruses
ALL_INF2 - number of influenze negative viruses
TITLE - ili activity? most have no report as the column

will have to look more into the details, but it looks like this dataset is recording the number of virus strains, not individual cases of that virus. specimens recieved/processed usually matches up with INF + or -, indicating that those specimens were all tested and sorted into either yes, it was an influenza virus, or no, it was not. 

```{r}
#getting a look at the data
plot_missing(raw_data)
```
This function looks at how many missing rows are present in each column. most of the useful information we want is barely 25% there, indicating that from the date range 1995-2019, barely 5 years of data is usable. 

```{r}
table(raw_data$FLUREGION)
```
  
We'll pick SE asia for the ts

```{r}
SE_Asia <- raw_data[which(raw_data$FLUREGION == 'Southern Asia'), ] #select rows from SE asia
tlist <- SE_Asia[complete.cases(SE_Asia$ALL_INF), ] #select only rows that aren't missing data in the all_inf column
t_ind <- tlist[which(tlist['Ã¯..Country'] == 'India'), ]
ttime = t_ind$SDATE %>% as.Date("%m/%d/%Y") #store the timeline as date object vector
#it looks like all the weeks fall on the same SDATE's, so it should be safe to use the same date vector for different countries.

ggplot(t_ind) +
  geom_line(aes(x = ttime, y = ALL_INF, col = 'Total Influenza Cases'))+
  geom_line(aes(x = ttime, y = AH1, col = 'AH1'))+
  geom_line(aes(x = ttime, y = AH1N12009, col = '2009 Swine Flu'))+
  geom_line(aes(x = ttime, y = AH3, col = 'AH3'))+
  geom_line(aes(x = ttime, y = AH5, col = 'AH5'))+
  geom_line(aes(x = ttime, y = ANOTSUBTYPED, col = 'Untyped Inf A'))+
  geom_line(aes(x = ttime, y = INF_A, col = 'total type A'))+
  geom_line(aes(x = ttime, y = BYAMAGATA, col = 'Yamagata STRAIN B'))+
  geom_line(aes(x = ttime, y = BVICTORIA, col = 'Victoria Strain B'))+
  geom_line(aes(x = ttime, y = BNOTDETERMINED, col = 'Untyped Inf B'))+
  geom_line(aes(x = ttime, y = INF_B, col = 'total type B'))
```
Selecting rows that have values in the 'total influenza strains detected' column leaves us with data from SE asia from 1995-2018, with some variation by country. 
If we isolate data from a single country, Inda, we see that the 'window' of available data shrinks to roughly 1999 to 2018. 




let's set primary time series to total influenza cases from india
*here you should be able to feed in any time series object as 'tdata' and have the blocks below work
*as long as you have the date values saved to a vector 'ttime' as well, but that's just for the graphing bit
```{r}
tdata <- t_ind$ALL_INF %>% as.ts()
```
and now we can run hopefully adaptable analysis cells below

actual time series analysis goes here, assuming you have a ts item labeled 'tdata'
```{r}
#diagnoses
#wrap objects in invisible() to hide the long console output and leave only the graph
invisible(plotts.sample.wge(tdata))
#stationairity
adf.test(tdata)
pacf(tdata)

#changepoint
par(mfrow = c(2,1))

v2 <- tdata

v2.pelt <- cpt.meanvar(v2, test.stat = 'Poisson', method = "PELT")
plot(v2.pelt, main = 'PELT changes in variance')
cpts.ts(v2.pelt)

v2.bs <- cpt.meanvar(v2, test.stat = 'Poisson', method = 'BinSeg')
plot(v2.bs, cpt.width = 3, main = 'BinSeg changes in Mean Variance')
cpts.ts(v2.bs)

```

```{r}
#model fitting
pspan = 0:5 #range of values to look for possible p and q coefficients for AR and MA
qspan = 0:5
aic_results <- aic5.wge(tdata, p = pspan, q = qspan)
bic_results <- aic5.wge(tdata, p = pspan, q = qspan, type = 'bic')
aic_results
bic_results

m1 = est.arma.wge(tdata, p = aic_results[1, 1], q = aic_results[1, 2], factor = TRUE) #feed top AIC or BIC into arma estimation to generate coefficients
m1$phi
m1$theta

#simple single forecast and test
weeks_compare = 26 #how many weeks to reserve for testing
f1 <- tdata[1:(length(tdata)-weeks_compare)] %>% fore.aruma.wge(phi = m1$phi, theta = m1$theta, d = 0, n.ahead = weeks_compare)
mse <- (tdata[((length(tdata)-weeks_compare)+1):(length(tdata))] - f1$f)^2 %>% mean()
paste('Mean Squared Error: ', mse)

#change x and y line names to match whatever dataframe you've stored the time series in
timeFrame <- data.frame(date = ttime, inf_cases = tdata)
g3 <- ggplot(timeFrame)+
  geom_line(aes(x = date, y = tdata, color = 'black'), size = 0.5)+
  geom_line(aes(x = date, y = c(rep(NA, length(tdata)-weeks_compare), f1$f), color = 'red'), size= 1) + 
  scale_color_discrete(name = "total_patients", labels = c('actual', 'predicted')) +
  ggtitle(paste('ARIMA ', aic_results[1, ],  'Forecast of ', weeks_compare, ' units'), subtitle = paste('Mean Squared Error = ', mse))
  
g3
```









